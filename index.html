<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>競艇 v1（払戻123 最終版）</title>
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;margin:0;background:#0b0f14;color:#e9eef5}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.card{background:#121a24;border:1px solid #1c2a3b;border-radius:14px;padding:14px;margin:10px 0}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a3e5b;background:#0d141d;color:#cfe3ff}
.grid{display:grid;gap:10px}
.g2{grid-template-columns:1fr 1fr}
.badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:900;border:1px solid #2a3e5b}
.b-buy{color:#6ee7b7}.b-no{color:#fca5a5}.b-wait{color:#ffd27d}
.raceCard{background:#111a26;border:1px solid #1c2a3b;border-radius:14px;padding:12px;margin:10px 0}
.resultLine{margin-top:6px;color:#b8c5d6}
input{width:100%;padding:8px;border-radius:8px;border:1px solid #223248;background:#0d141d;color:#fff}
.btn{background:#2b6ff7;border:0;color:#fff;padding:8px 12px;border-radius:8px;font-weight:800;cursor:pointer}
</style>
</head>

<body>
<div class="wrap">
<h1>競艇 v1（払戻123 最終版）</h1>

<div class="card">
<button class="btn" onclick="refresh()">更新</button>
<button class="btn" onclick="sendBuy()">BUY送信</button>
</div>

<div class="card">
<div class="pill">レース一覧</div>
<div id="list"></div>
</div>
</div>

<script>
const GAS_URL="https://script.google.com/macros/s/AKfycbw5C8p_tw_dK9m5OWPrekxfbHz1mNq949fjBq1ymTo8xNCjtIGTRGbmVZYQyO3-O3fo/exec";
const RESULTS_URL="https://boatraceopenapi.github.io/results/v2/today.json";

function normalizeCombo(s){
 return String(s).replace(/[–—ー_]/g,"-").replace(/,/g,"-").replace(/\s+/g,"").replace(/[^0-9-]/g,"");
}

function extractResultAndPayout123(rr){
 const out={top3:null,pay3t123:null,pay3f123:null};
 if(!rr) return out;

 // top3
 for(const k in rr){
  const v=rr[k];
  if(typeof v==="string" && v.match(/\b[1-6]-[1-6]-[1-6]\b/)){
   out.top3=v;break;
  }
 }

 const payouts=rr.payouts||rr.payout||rr.refunds||rr.haraimodoshi||{};
 const find=(arr)=>{
  if(!Array.isArray(arr)) return null;
  for(const it of arr){
   if(normalizeCombo(it.combination)==="1-2-3"){
    const n=Number(it.payout||it.pay||it.amount);
    if(Number.isFinite(n)) return n;
   }
  }
  return null;
 };

 out.pay3t123=find(payouts.trifecta||payouts.sanrentan||[]);
 out.pay3f123=find(payouts.trio||payouts.sanrenpuku||[]);
 return out;
}

async function refresh(){
 const res=await fetch(RESULTS_URL);
 const js=await res.json();
 const list=document.getElementById("list");
 list.innerHTML="";
 (js.results||[]).forEach(r=>{
  const ex=extractResultAndPayout123(r);
  const div=document.createElement("div");
  div.className="raceCard";
  div.innerHTML=`
  <div><b>${r.race_stadium_name||""} ${r.race_number||""}R</b></div>
  <div class="resultLine">結果: ${ex.top3||"-"}</div>
  <div class="resultLine">払戻123: 3連単=${ex.pay3t123??"未取得"} / 3連複=${ex.pay3f123??"未取得"}</div>
  `;
  list.appendChild(div);
 });
}

async function sendBuy(){
 const payload={date:new Date().toISOString().slice(0,10),venue:"TEST",race:0,status:"BUY"};
 await fetch(GAS_URL,{method:"POST",mode:"no-cors",body:JSON.stringify(payload)});
 alert("送信しました（Master確認）");
}

refresh();
</script>
</body>
</html>
